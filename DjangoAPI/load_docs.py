import os
import chromadb
from sentence_transformers import SentenceTransformer

def run_load():
    print("--- –ó–∞–ø—É—Å–∫ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∑–Ω–∞–Ω–∏–π Sklad-Intelligence-v1 ---")

    # 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ ChromaDB (–≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏ Docker –∏–º—è —Ö–æ—Å—Ç–∞ 'chromadb')
    try:
        client = chromadb.HttpClient(host='chromadb', port=8000)
        print("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ChromaDB —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ChromaDB: {e}")
        return

    # 2. –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é
    collection = client.get_or_create_collection(name="sklad_knowledge")

    # 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (—Å–∫–∞—á–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)
    print("üß† –ó–∞–≥—Ä—É–∑–∫–∞ –ò–ò-–º–æ–¥–µ–ª–∏ (SentenceTransformer)...")
    model = SentenceTransformer('all-MiniLM-L6-v2')

    # 4. –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è (–º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –ª—é–±—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
    knowledge = [
        "–°–∫–ª–∞–¥—Å–∫–æ–π –∫–æ–º–ø–ª–µ–∫—Å 'Freedom Edge' —Ä–∞–±–æ—Ç–∞–µ—Ç –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ.",
        "–õ–∏—Ç–∏–µ–≤—ã–µ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã –∏ –æ–ø–∞—Å–Ω—ã–µ –≥—Ä—É–∑—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –≤ –ó–æ–Ω–µ –ê-1.",
        "–ü—Ä–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –≤—ã—à–µ +25 –≥—Ä–∞–¥—É—Å–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è —Å–µ–∫—Ç–æ—Ä–∞ –ë.",
        "–ò–Ω–∂–µ–Ω–µ—Ä –ú–∞–∫—Å–∞—Ç —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Å–∏—Å—Ç–µ–º—ã Sklad-Intelligence-v1.",
        "–ó–∞–ø—Ä–µ—â–µ–Ω–æ —Ä–∞–∑–º–µ—â–∞—Ç—å —Ç—è–∂–µ–ª—ã–µ –≥—Ä—É–∑—ã –Ω–∞ –≤–µ—Ä—Ö–Ω–∏—Ö –ø–æ–ª–∫–∞—Ö —Å—Ç–µ–ª–ª–∞–∂–µ–π —Ç–∏–ø–∞ '–°'."
    ]

    # 5. –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –≤ –≤–µ–∫—Ç–æ—Ä—ã (—ç–º–±–µ–¥–¥–∏–Ω–≥–∏) –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    print("üì• –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –≤–µ–∫—Ç–æ—Ä–Ω—É—é –±–∞–∑—É...")
    for i, text in enumerate(knowledge):
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–µ–∫—Ç–æ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞
        vector = model.encode(text).tolist()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ ChromaDB
        collection.add(
            embeddings=[vector],
            documents=[text],
            ids=[f"doc_{i}"]
        )

    print(f"üéâ –£—Å–ø–µ—Ö! –í –±–∞–∑—É –∑–∞–≥—Ä—É–∂–µ–Ω–æ {len(knowledge)} –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.")

if __name__ == "__main__":
    run_load()
